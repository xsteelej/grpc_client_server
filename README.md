# gRPC Client / Server Demo

The project consists of three modules:
* clientApi
* portsService
* grpc

### clientApi

This service is responsible for parsing the json file and sending the objects to the portsService using gRPC.
It also provides a REST endpoint to read data fromn the portsService.

#### _Testing_

``go test -v -coverprofile cover.out ./...``

There are currently only unit tests around the reading of the json file and parsing. Further tests could be written for the http REST interface using _httptest.NewRecorder()_


#### _Running_

The client can be run from the cli or within docker.

**Example running from the CLI**
```
cd grpc_client_server/clientApi/cmd/clientApi

go build -o clientApi main.go

GRPC_SERVER_ADDRESS="localhost:9090" SERVER_PORT=":8081" JSON_FILE="./ports.json" ./clientApi
```

**Example running in Dockerfile**

(_The portsService should be running in docker-compose_)

```
cd grpc_client_server/clientApi

docker build . -t clientapi:latest

docker run -p:8081:8081 --network=grpc_client_server_services \
-e JSON_FILE=/data/ports.json -e GRPC_SERVER_ADDRESS="ports-service:9090" \
-v /Users/johste04/code/tech_test/grpc_client_server/clientApi/ports.json:/data/ports.json clientapi
```

### portsService

Responsible for serving storing / retrieving ports objects. This service starts a gRPC service.

#### _Testing_

``go test -v -coverprofile cover.out ./...``

The service can be run from the cli or within docker.

#### _Running_

The service can be run from the cli or by using docker-compose.

**Example running from the CLI**
```
cd grpc_client_server/portsService/cmd/portsService

go build -o portsService main.go

GRPC_PORT=":9090" ./portsService
```

**Example running from docker-compose**

```
cd grpc_client_server

docker-compose build

docker-compose up
```

### grpc

A definition of the ports gRPC service and data types. The code for the client is auto-generated from the **_ports.proto_** file.

The client / server code is generated by performing the following steps:

```
cd grpc
protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. \
--go-grpc_opt=paths=source_relative ./ports.proto
```

## Design choices / future enhancements

* Given more time, the clientApi should also run in docker-compose. Due to time constraints I failed to get a volume pointing to the local ports.json working.

* The json parsing in clientApi parses each character byte by byte. This was chosen over ``json.Decoder`` because Decoder tokenises each element and it was more complex to reconstruct a valid json string per object. By parsing each byte at a time, it was easier to preserve the original json format of each object and stream from the large file. It is likely that a more efficient algorithm could be used in the future using ``json.Decoder``.

* Write some tests in clientApi for the REST interface using ``httptest.NewRecorder()``.

* A panic occurs when the portsService attempts to bind to a port already in use. This should be handled more gracefully.

* Use a NoSQL document store such as MongoDB to persist the data. 
